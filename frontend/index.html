<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ikigai Mental Health Checker</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fb;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 15px;
    }

    button {
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      font-weight: bold;
    }

    button:hover {
      background: #4338ca;
    }

    .card {
      background: #eef2ff;
      padding: 12px;
      border-radius: 10px;
      margin-top: 12px;
      line-height: 1.6;
    }

    h3 {
      margin-top: 25px;
      color: #333;
    }
  </style>
</head>

<body>

<div class="container">
  <h2>ğŸŒ± Ikigai Mental Health Checker</h2>

  <input id="sleep" type="number" placeholder="Sleep hours (e.g. 7)" />
  <input id="study" type="number" placeholder="Study hours (e.g. 5)" />
  <input id="screen" type="number" placeholder="Screen time (hrs)" />
  <input id="activity" type="number" placeholder="Physical activity (mins)" />
  <input id="mood" type="number" placeholder="Mood (1â€“5)" />

  <button onclick="analyze()">Analyze</button>

  <div id="result"></div>
</div>

<!-- ================== SCRIPT ================== -->
<script>
/* ğŸ”’ Protect page: must be logged in */
const currentUser = JSON.parse(localStorage.getItem("ikigai_current_user"));
if (!currentUser) {
  alert("Please login first");
  window.location.href = "login.html";
}

/* ğŸ“Š MAIN ANALYZE FUNCTION */
async function analyze() {
  const data = {
    sleep: Number(document.getElementById("sleep").value),
    study: Number(document.getElementById("study").value),
    screen: Number(document.getElementById("screen").value),
    activity: Number(document.getElementById("activity").value),
    mood: Number(document.getElementById("mood").value)
  };

  // Basic validation
  if (Object.values(data).some(v => isNaN(v))) {
    alert("Please fill all fields correctly");
    return;
  }

  const response = await fetch("http://127.0.0.1:5000/ikigai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const res = await response.json();

  // âœ… SHOW RESULT
  document.getElementById("result").innerHTML = `
    <h3>ğŸ”¹ Daily Habit Scores</h3>
    <div class="card">
      ğŸ›Œ Sleep: ${res.layer1_normalized.sleep_score}<br>
      ğŸ“š Study: ${res.layer1_normalized.study_score}<br>
      ğŸ“± Screen: ${res.layer1_normalized.screen_score}<br>
      ğŸƒ Activity: ${res.layer1_normalized.activity_score}<br>
      ğŸ˜Œ Mood: ${res.layer1_normalized.mood_score}
    </div>

    <h3>ğŸ§  Stress & Productivity</h3>
    <div class="card">
      Stress Score: ${res.layer2_scores.stress_score}<br>
      Stress Level: <b>${res.layer2_scores.rule_based_stress}</b><br>
      Productivity: ${res.layer2_scores.productivity_score}
    </div>

    <h3>ğŸŒ¸ Ikigai Balance</h3>
    <div class="card">
      Love â¤ï¸: ${res.layer3_ikigai.love}<br>
      Good At ğŸ¯: ${res.layer3_ikigai.good_at}<br>
      Need ğŸŒ: ${res.layer3_ikigai.need}<br>
      Value ğŸ’¼: ${res.layer3_ikigai.value}<br><br>
      â­ <b>Ikigai Score: ${res.layer3_ikigai.ikigai_score}</b>
    </div>
  `;

  // âœ… SAVE RESULT FOR USER
  saveIkigaiResult(
    res.layer3_ikigai.ikigai_score,
    res.layer3_ml_support.final_stress_level
  );
}

/* ğŸ’¾ SAVE RESULT TO LOCAL STORAGE */
function saveIkigaiResult(score, stress) {
  const currentUser = JSON.parse(localStorage.getItem("ikigai_current_user"));
  if (!currentUser) return;

  let users = JSON.parse(localStorage.getItem("ikigai_users")) || [];
  const user = users.find(u => u.email === currentUser.email);
  if (!user) return;

  if (!user.ikigaiHistory) {
    user.ikigaiHistory = [];
  }

  user.ikigaiHistory.push({
    score,
    stress,
    date: new Date().toISOString().split("T")[0]
  });

  localStorage.setItem("ikigai_users", JSON.stringify(users));
}
</script>

</body>
</html>

